<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento com Stripe</title>
    <!-- 1. Carregar o script do Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0; padding: 20px; box-sizing: border-box;
        }
        .container {
            background-color: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%;
            max-width: 400px; text-align: center;
        }
        h1, h2, p { color: #333; }
        h1 { font-size: 1.8rem; margin-top: 0; }
        .price {
            font-size: 2.5rem; font-weight: bold; color: #6772e5;
            margin: 10px 0 20px 0;
        }
        #payment-form { margin-top: 14px; text-align: left; }
        /* O cont√™iner para o Payment Element n√£o precisa de estilos, o Stripe cuida disso */
        #payment-element {
             margin-bottom: 20px;
        }
        #error-message {
            color: #dc3545; font-size: 0.9rem;
            margin-top: 10px; min-height: 1rem;
        }
        .btn {
            display: block; width: 100%; padding: 15px; font-size: 1.1rem;
            font-weight: bold; border: none; border-radius: 8px;
            cursor: pointer; transition: all 0.3s ease; margin-top: 15px;
        }
        .btn-pay { background-color: #222222; color: white; }
        .btn-pay:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .btn-redirect {
            background-color: #ffc107; color: #212529;
            text-decoration: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); width: 24px; height: 24px;
            border-radius: 50%; border-left-color: #fff;
            animation: spin 1s ease infinite; margin: 0 auto;
        }
        .alinhamento-2{
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            width: 100%;
        }
        .alinhamento-1{
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .text-aprovacao{
            background-color: red;
            color: #ffffff;
            padding-top: 6px;
            padding-bottom: 6px;
            padding-left: 10px;
            padding-right: 10px;
            border-radius: 100px;
            font-size: 14px;
            margin: 0px;
        }
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        .profile-header img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #007bff;
            margin-bottom: 8px;
        }
        img {
            overflow-clip-margin: content-box;
            overflow: clip;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <!-- SE√á√ÉO 1: FORMUL√ÅRIO DE PAGAMENTO (VIS√çVEL NO IN√çCIO) -->
        <div id="paymentSection">
            <div class="profile-header">
            </div>
            <h1>GRUPO VIP TELEGRAM üîû + WHATS APP PESSOAL</h1>
            <p>Pague com cart√£o para liberar seu acesso aos conte√∫dos. ‚ö† N√£o feche nem atualize esta p√°gina. </p>
            <div class="price">‚Ç¨ 4.90</div>
            
            <div class="alinhamento-2">
                <p class="text-aprovacao">
                    libera√ß√£o imediata 
                </p>    
            </div>

            <form id="payment-form">
                <div id="payment-element">
                    <!-- O Payment Element do Stripe ser√° inserido aqui -->
                </div>
                <button id="submit-button" class="btn btn-pay">
                    <span id="button-text">Pagar Agora</span>
                </button>
                <div id="error-message" role="alert"></div>
            </form>
            <div class="alinhamento-1">
                Powered by <svg width="54" fill="#675dff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M165 208.7L121.7 217.9L121.5 360.3C121.5 386.6 141.3 403.6 167.6 403.6C182.2 403.6 192.9 400.9 198.8 397.7L198.8 363.9C193.1 366.2 165.1 374.4 165.1 348.2L165.1 285L198.8 285L198.8 247.2L165.1 247.2L165 208.7zM254.1 260.3L251.4 247.2L213 247.2L213 400.4L257.3 400.4L257.3 297.3C267.8 283.5 285.5 286.2 291.2 288L291.2 247.2C285.2 245.1 264.5 241.2 254.1 260.3zM346.4 188L301.8 197.5L301.8 233.7L346.4 224.2L346.4 188zM44.9 292.3C44.9 285.4 50.7 282.7 60 282.6C73.5 282.6 90.7 286.7 104.2 294L104.2 252.2C89.5 246.4 74.8 244.1 60.1 244.1C24.1 244.1 .1 262.9 .1 294.3C.1 343.5 67.6 335.5 67.6 356.7C67.6 364.9 60.5 367.6 50.6 367.6C35.9 367.6 16.9 361.5 2 353.4L2 393.4C18.5 400.5 35.2 403.5 50.5 403.5C87.4 403.5 112.8 387.7 112.8 355.7C112.8 302.8 44.9 312.3 44.9 292.3zM640 325.6C640 280.1 618 244.2 575.8 244.2C533.6 244.2 507.9 280.1 507.9 325.3C507.9 378.8 538.2 403.5 581.4 403.5C602.6 403.5 618.5 398.7 630.6 392L630.6 358.6C618.5 364.7 604.6 368.4 587 368.4C569.7 368.4 554.5 362.3 552.5 341.5L639.4 341.5C639.6 339.2 640 329.9 640 325.6zM552.1 308.8C552.1 288.8 564.4 280.4 575.5 280.4C586.4 280.4 598 288.8 598 308.8L552.1 308.8zM439.2 244.2C421.8 244.2 410.6 252.4 404.4 258.1L402.1 247.1L363 247.1L363 451.9L407.4 442.5L407.5 392.3C413.9 397 423.4 403.5 438.9 403.5C470.7 403.5 499.7 380.3 499.7 323.9C499.8 272.3 470.4 244.2 439.2 244.2zM428.6 366.7C418.2 366.7 412 362.9 407.7 358.3L407.4 292.3C412 287.2 418.4 283.5 428.6 283.5C444.8 283.5 456 301.7 456 324.9C456.1 348.8 445.1 366.7 428.6 366.7zM301.9 400.4L346.5 400.4L346.5 247.2L301.9 247.2L301.9 400.4z"/></svg>
            </div>
            
        </div>
        
        <!-- SE√á√ÉO 2: ACESSO LIBERADO (ESCONDIDA) -->
        <div id="successSection" class="hidden">
            <h2>Pagamento Confirmado!</h2>
            <p>O seu acesso foi liberado. Clique no bot√£o abaixo para aceder ao conte√∫do.</p>
            <a href="https://t.me/+VvkKZ3RiSGVhOWUx" class="btn btn-redirect">
                Aceder ao Conte√∫do
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIGURA√á√ÉO ---
            const stripePublishableKey = 'pk_live_51RkXZZBxBINmBHB4Q2t5ePWqr783Hs8wXgaVHcyGdApbAIB44tXvnhC8CHw2vyxVS9MCJKu2OfYXXZwvCY1P0jLU00NzCL7aTQ'; // ‚ö†Ô∏è COLE A SUA CHAVE AQUI
            const stripe = Stripe(stripePublishableKey);

            const paymentForm = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-button');
            const errorMessage = document.getElementById('error-message');
            const paymentSection = document.getElementById('paymentSection');
            const successSection = document.getElementById('successSection');

            let elements;

            // --- INICIALIZA√á√ÉO ---
            initialize();

            async function initialize() {
                try {
                    const response = await fetch('https://stripe-carol-vip.vercel.app/create-payment-intent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`O servidor respondeu com um erro: ${response.status}. Detalhes: ${errorBody}`);
                    }

                    const { clientSecret } = await response.json();
                    if (!clientSecret) {
                        throw new Error('O clientSecret n√£o foi recebido do servidor.');
                    }
                    
                    // --- NOVO C√ìDIGO DO FORMUL√ÅRIO INTEGRADO AQUI ---
                    const appearance = { theme: 'stripe' }; // Apar√™ncia padr√£o
                    const options = {
                        layout: {
                            type: 'accordion',
                            defaultCollapsed: false,
                            radios: true,
                            spacedAccordionItems: false
                        }
                    };
                    
                    elements = stripe.elements({ clientSecret, appearance });
                    const paymentElement = elements.create('payment', options);
                    paymentElement.mount('#payment-element');
                    // --- FIM DO NOVO C√ìDIGO DO FORMUL√ÅRIO ---

                } catch (error) {
                    console.error('Erro na inicializa√ß√£o:', error);
                    showMessage('N√£o foi poss√≠vel carregar o formul√°rio. Verifique se o servidor est√° em execu√ß√£o e recarregue a p√°gina.');
                }
            }

            // --- SUBMISS√ÉO DO FORMUL√ÅRIO ---
            paymentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(true);

                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.href.split('?')[0],
                    },
                });

                if (error && (error.type === "card_error" || error.type === "validation_error")) {
                    showMessage(error.message);
                } else if (error) {
                    showMessage("Ocorreu um erro inesperado ao processar o pagamento.");
                }

                setLoading(false);
            });
            
            // --- VERIFICA√á√ÉO DO ESTADO DO PAGAMENTO (AP√ìS REDIRECIONAMENTO) ---
            const clientSecret = new URLSearchParams(window.location.search).get("payment_intent_client_secret");
            if (clientSecret) {
                stripe.retrievePaymentIntent(clientSecret).then(({ paymentIntent }) => {
                    switch (paymentIntent.status) {
                        case "succeeded":
                            paymentSection.classList.add('hidden');
                            successSection.classList.remove('hidden');
                            break;
                        case "processing":
                            showMessage("O seu pagamento est√° a ser processado.");
                            break;
                        case "requires_payment_method":
                            showMessage("O pagamento falhou. Por favor, tente um m√©todo de pagamento diferente.");
                            break;
                        default:
                            showMessage("Algo correu mal.");
                            break;
                    }
                });
            }

            // --- FUN√á√ïES AUXILIARES ---
            function setLoading(isLoading) {
                const buttonText = submitButton.querySelector('#button-text');
                if (isLoading) {
                    submitButton.disabled = true;
                    // Adiciona o spinner dentro do span, se n√£o existir
                    if (!submitButton.querySelector('.spinner')) {
                         buttonText.innerHTML = '<div class="spinner"></div>';
                    }
                } else {
                    submitButton.disabled = false;
                    buttonText.innerHTML = 'Pagar Agora';
                }
            }

            function showMessage(messageText) {
                errorMessage.textContent = messageText;
                setTimeout(() => { errorMessage.textContent = ""; }, 5000);
            }
        });
    </script>
</body>
</html>

